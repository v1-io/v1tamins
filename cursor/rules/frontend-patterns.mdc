---
description: Frontend component patterns, styling, and backend integration
globs: web/src/components/**/*.tsx,web/src/app/api/**/*.ts,**/*.tsx,**/*.ts
alwaysApply: false
---

# Frontend Patterns

## Component Hierarchy
Pass complete hierarchy context through props:
```typescript
// Always pass full hierarchy down
<ChildComponent
  dataSourceId={dataSourceId}
  databaseId={databaseId}
  schemaId={schemaId}
  // ... other props
/>

// Update interfaces when adding hierarchy
interface ComponentProps {
  dataSourceId: string;
  databaseId: string;
  schemaId: string;
  // ... other props
}
```

**Hierarchy Chain Example:**
1. `DataCatalog` → `DatabaseCard` (pass `dataSourceId`)
2. `DatabaseCard` → `SchemaTable` (pass `dataSourceId`, `databaseId`)
3. `SchemaTable` → `TableTable` (pass `dataSourceId`, `databaseId`, `schemaId`)

## API Integration
Always use hierarchical endpoints matching the data structure:
```typescript
// ✅ CORRECT - Full hierarchy
const response = await fetch(
  `/api/data-source/${dataSourceId}/database/${databaseId}/schema/${schemaId}/table/${tableId}`,
  { method: 'PUT', body: JSON.stringify(updates) }
);

// ❌ WRONG - Non-hierarchical shortcuts
const response = await fetch(`/api/tables/${tableId}`, { ... });
```

## Server-Side API Routes
For Next.js API routes that need to call backend services:

**Authentication Pattern:**
```typescript
// ✅ CORRECT - Use shared client helpers
import { configService } from '@/lib/configServiceClient';

const organization = await configService.organization.get(orgId);

// ❌ WRONG - Manual token plumbing + fetch
import { serverMultiAudienceTokenManager } from '@/lib/auth/serverMultiAudienceTokenManager';
const token = await serverMultiAudienceTokenManager.getToken('config-api');
await fetch(`${CONFIG_SERVICE_URL}/api/...`, { headers: { Authorization: `Bearer ${token}` } });
```

**Requirements:**
- Call the shared service clients from API routes (`configService`, `analystService`, etc.)
- Let the clients pick the right token manager; don't bypass them with manual fetch logic
- Avoid duplicating auth/token retrieval code in routes

## Full-Stack Integration Flow
When adding functionality that connects frontend to backend:
1. **Backend**: Implement or verify necessary API endpoints exist
2. **Service Clients**: Update clients (e.g., `configServiceClient.ts`, `analystServiceClient.ts`)
3. **Next.js APIs**: Create/update API routes in `/web/src/app/api/*` as gateways
4. **Context/Hooks**: Update contexts (`/web/src/contexts`) and hooks (`/web/src/hooks`)
5. **UI Components**: Implement in `/web/src/components/` with reusable patterns

## UI State Management
**Always implement these states:**
- **Loading**: Show loading indicators during API calls
- **Optimistic Updates**: Update UI immediately and assume success response
- **Error Rollback**: Revert UI changes on error response
- **Error Display**: Show user-friendly error messages

## Styling Guidelines
1. **ShadCN Components**: Always use ShadCN components for UI elements
2. **No Hardcoding**: Never hardcode colors, shadows, or radii - use CSS variables from `globals.css`
3. **Semantic Classes**: Create semantic utilities like `.rel-approved`, `.status-pending` in `@layer utilities`
4. **New Tokens**: Add CSS variables to `globals.css`, use via `@apply`
5. **Contrast**: Use `text-destructive-foreground` on destructive backgrounds
6. **Naming**: Use context prefix + kebab-case (e.g., `role-system-admin`)
7. **Variants**: Use `class-variance-authority` (CVA) for component variants

## Testing
- **NEVER write tests** unless explicitly requested
- When requested: Place in `web/__tests__/` matching source structure
- Mock external calls and share mocking functions in `testUtils.ts`
- **DON'T** test for specific UI strings

## ID Management
Ensure items have IDs for React keys and API operations:
```typescript
const ensureId = (item: { id?: string }): string => {
  if (!item.id) {
    item.id = crypto.randomUUID();
  }
  return item.id;
};
```
