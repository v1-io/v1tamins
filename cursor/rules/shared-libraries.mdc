---
description: Organization of shared code across services in the common library
globs: services/common/lib/**/*.py,services/*/lib/**/*.py
alwaysApply: false
---

# Shared Libraries Organization

## Core Principle
**Any code used by multiple services MUST be in `services/common/lib/`**

This prevents duplication, centralizes updates, and ensures consistency across services.

## What Goes in Common Lib
- Utility functions and helpers
- Database models (SQLAlchemy, Pydantic)
- Service clients (internal/external APIs)
- Custom exceptions and error classes
- Shared constants, enums, and base classes
- Core data structures and abstractions
- Embedding logic and processing utilities

## Directory Organization
Organize by functionality in logical subdirectories:

- **`clients/`**: Service clients (config service, external APIs)
- **`models/`**: Data models (Pydantic for APIs, SQLAlchemy for DB)
- **`db_utils/`**: Database connections and session management
- **`embedding/`**: Shared embedding generation/handling
- **`encryption/`**: Common encryption/decryption utilities
- **`markdown/`**: Shared markdown processing tools
- **`integrations/`**: Database connectors and integration utilities
- **`permissions/`**: Authorization and access control utilities
- **`jobs/`**: Background job utilities and task management
- **`cache_utils/`**: Caching mechanisms and utilities
- **`tests/`**: Shared test utilities and fixtures

## Adding Dependencies
When adding new dependencies to the common library:
- **MUST** declare them in `services/common/setup.py`
- Follow the existing pattern for version specifications
- Consider optional dependencies for specialized connectors

## Usage Pattern
Services import from common lib:
```python
# ✅ CORRECT - Import from common lib
from lib.clients.config_client import ConfigServiceClient
from lib.models.user import User
from lib.encryption.utils import encrypt_sensitive_data

# ❌ WRONG - Duplicating code in service
from .local_utils import encrypt_data  # Don't recreate shared utilities
```

## Integration Connectors
Database connectors belong in common lib, not individual services:
- Place in `services/common/lib/integrations/connectors/database/`
- Follow the Universal Data Interface pattern
- Register in the connector manifest
- Add configuration templates to the template manager

This ensures connectors are reusable across multiple services that need database access.
